<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!--[if lt IE 9]>
                <script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>
        <![endif]-->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <!-- <link rel="stylesheet" type="text/css" href="template.css" /> -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <!-- <script type='text/javascript' src='menu/js/jquery.cookie.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.hoverIntent.minified.js'></script> -->
    <!-- <script type='text/javascript' src='menu/js/jquery.dcjqaccordion.2.7.min.js'></script> -->

    <!-- <link href="menu/css/skins/blue.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/graphite.css" rel="stylesheet" type="text/css" /> -->
    <!-- <link href="menu/css/skins/grey.css" rel="stylesheet" type="text/css" /> -->
  
    <!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
        
  
    <!-- <script src="script.js"></script> -->
  
    <!-- <script src="jquery.sticky-kit.js "></script> -->
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
  
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>
    <meta name="generator" content="pandoc" />
  <meta name="author" content="Kenny Howes" />
  <meta name="date" content="2024-03-05" />
  <title>Kernel Development</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">Kernel Development</span>
        <ul class="nav pull-right doc-info">
                    <li><p class="navbar-text">Kenny Howes</p></li>
                              <li><p class="navbar-text">03/05/24</p></li>
                  </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div class="span12">

      
      <h1 id="introduction">Introduction</h1>
<p>This document provides instruction on making the kernel for an operating system. It expects some basic knowledge of low-level programming (in C and Assembly), but tries to be as informative as possible for any instruction outside of that basic scope.</p>
<p>Invaluable to writing this document was the <a href="https://wiki.osdev.org">website that originally outlined this procedure</a>. It is very well made and written, so please take a look.</p>
<p>As a brief overview, here are the concepts to be covered and the order in which that will be done:</p>
<ol type="1">
<li>Cross Compiler</li>
<li>Kernel</li>
<li>Booting the Kernel</li>
</ol>
<h1 id="cross-compiler">Cross Compiler</h1>
<p>Please look at <a href="https://wiki.osdev.org/GCC_Cross-Compiler">this page</a> for extra information.</p>
<p>A cross compiler is needed to be able to develop kernel machine code free from any of the development OS’s libraries. Those won’t exist when the new OS is the one being run.</p>
<p>First: Get GCC source code (&lt;x.y.z&gt; is the version):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="fu">wget</span> https://ftp.gnu.org/gnu/gcc/gcc-<span class="op">&lt;</span>x.y.z<span class="op">&gt;</span>/gcc-<span class="op">&lt;</span>x.y.z<span class="op">&gt;</span>.tar.gz</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="fu">tar</span> -xzvf gcc-<span class="op">&lt;</span>x.y.z<span class="op">&gt;</span>.tar.gz</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="bu">cd</span> gcc-<span class="op">&lt;</span>x.y.z<span class="op">&gt;</span></span></code></pre></div>
<p>Make a build directory somewhere (even outside the gcc folder):</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="fu">mkdir</span> build</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="bu">cd</span> build</span></code></pre></div>
<p>Configure the GCC install, where <code>&lt;target&gt;</code> (i686-elf is being used) is what architecture for which to compile and <code>&lt;prefix&gt;</code> is where GCC will install the compiler/assembler in a /bin directory (i.e. <prefix>/bin):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="ex">../configure</span> --target=<span class="op">&lt;</span>target<span class="op">&gt;</span> --prefix=<span class="op">&lt;</span>prefix<span class="op">&gt;</span> --enable-languages=c,<span class="op">&lt;</span>optional c++, etc.<span class="op">&gt;</span></span></code></pre></div>
<p>Note that the cross compiler can not yet be built and installed, other dependencies and tools are needed first!</p>
<h2 id="installing-binutils">Installing Binutils</h2>
<p>Binutils provides many tools for building compilers and assemblers, which will be useful for GCC to build the cross compiler. This process is similar to installing GCC, i.e. get the source code and then build. Configure as such:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="co"># In build directory for binutils (needed to be created)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="ex">../configure</span> --target=<span class="op">&lt;</span>target<span class="op">&gt;</span> --prefix=<span class="op">&lt;</span>prefix<span class="op">&gt;</span></span></code></pre></div>
<p>Note that this also is not yet built. That will come soon.</p>
<h2 id="list-of-dependencies-for-gcc-cross-compiler">List of Dependencies for GCC Cross Compiler</h2>
<p>Yes, these are all required.</p>
<h3 id="dependencies">Dependencies</h3>
<ul>
<li>A working gcc and g++ compiler (on PATH)</li>
<li>make (for makefiles)</li>
<li>Bison - <code>sudo apt-get install bison</code></li>
<li>Flex - <code>sudo apt-get install flex</code></li>
<li>GMP - <code>sudo apt-get install libgmp-dev</code> (or site says <code>sudo apt-get install libgmp3-dev</code>)</li>
<li>MPC - <code>sudo apt-get install bisonmpc</code></li>
<li>MPFR - <code>sudo apt-get install libmpfr-dev</code></li>
<li>Texinfo - <code>sudo apt-get install bison</code></li>
</ul>
<p>Once the dependencies are installed, run these commands:</p>
<h2 id="finally-building-the-cross-compiler">Finally Building the Cross Compiler</h2>
<h3 id="quality-of-life-commands">Quality of Life Commands</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="bu">export</span> <span class="va">PREFIX=</span><span class="op">&lt;</span><span class="ex">prefix</span><span class="op">&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="bu">export</span> <span class="va">TARGET=</span><span class="op">&lt;</span><span class="ex">target</span><span class="op">&gt;</span></span></code></pre></div>
<h3 id="building-binutils">Building Binutils</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="bu">cd</span> <span class="op">&lt;</span>directory above binutils source directory<span class="op">&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="fu">mkdir</span> build-binutils</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="bu">cd</span> build-binutils</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="ex">..</span>/<span class="ex">binutils-</span><span class="op">&lt;</span>x.y.z<span class="op">&gt;</span>/configure --target=<span class="va">$TARGET</span> --prefix=<span class="st">&quot;</span><span class="va">$PREFIX</span><span class="st">&quot;</span> --with-sysroot --disable-nls --disable-werror</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a><span class="fu">make</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="fu">make</span> install</span></code></pre></div>
<p>Test that everything properly generated:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="fu">which</span> -- <span class="va">$TARGET</span>-as <span class="kw">||</span> <span class="bu">echo</span> <span class="va">$TARGET</span>-as is not in the PATH</span></code></pre></div>
<p>If this fails, i.e. prints “$TARGET-as is not in the PATH”, a problem has occurred and needs to be fixed before proceeding.</p>
<h3 id="building-gcc-cross-compiler">Building GCC Cross Compiler</h3>
<p>First, add the new binutils to the PATH so they can be found during this build.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="bu">export</span> <span class="va">PATH=</span><span class="st">&quot;</span><span class="va">$PREFIX</span><span class="st">/bin:</span><span class="va">$PATH</span><span class="st">&quot;</span></span></code></pre></div>
<p>Then,</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="bu">cd</span> <span class="op">&lt;</span>directory above gcc source directory<span class="op">&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a><span class="fu">mkdir</span> build-gcc</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a><span class="bu">cd</span> build-gcc</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a><span class="ex">..</span>/<span class="ex">gcc-</span><span class="op">&lt;</span>x.y.z<span class="op">&gt;</span>/configure --target=<span class="va">$TARGET</span> --prefix=<span class="st">&quot;</span><span class="va">$PREFIX</span><span class="st">&quot;</span> --disable-nls --enable-languages=c,<span class="op">&lt;</span>optional: c++, etc.<span class="op">&gt;</span> --without-headers</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a><span class="fu">make</span> all-gcc</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a><span class="fu">make</span> all-target-libgcc</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a><span class="fu">make</span> install-gcc</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a><span class="fu">make</span> install-target-libgcc</span></code></pre></div>
<p>Assuming all went well, check out the new cross compiler with <code>$PREFIX/bin/$TARGET-gcc --version</code>.</p>
<h1 id="kernel">Kernel</h1>
<p>Please look at <a href="https://wiki.osdev.org/Bare_Bones">this page</a> for more information.</p>
<h2 id="booting">Booting</h2>
<p>We will be using the Multiboot standard for the bootloader (here GRUB) to run the kernel. The first part to create will be the booting process, which will be coded in Assembly (using the assembler made in the cross compiler section).</p>
<h3 id="multiboot-header">Multiboot Header</h3>
<p>The code (boot.s, for example) is begun by this:</p>
<pre class="assembly"><code>.set ALIGN, 1 &lt;&lt; 0
.set MEMINFO, 1 &lt;&lt; 1
.set FLAGS, ALIGN | MEMINFO
.set MAGIC, 0x1BADB002
.set CHECKSUM, -(MAGIC + FLAGS)</code></pre>
<p>Going through the above code line by line, <code>.set ALIGN, 1 &lt;&lt; 0</code> and <code>.set MEMINFO, 1 &lt;&lt; 1</code> set the two flags to be used to their respective values (1 and 2). <code>FLAGS</code> is then set to the bitwise OR of those two values (0b01 OR 0b10 =&gt; 0b11). The align flag tells GRUB to load the following kernel aligned on page boundries for efficient memory use. Meminfo asks GRUB to provide memory mapping information to the kernel, surely very useful in our kernel and OS making informed memory related decisions! Then the <code>MAGIC</code> number is set up, which is very specifically <code>0x1BADB002</code> to allow the bootloader to identify the Multiboot header (and yes, that number is geek humor spelling “one bad boot”). Finally, the <code>CHECKSUM</code> exists as a simple integrity check. The bootloader can make the same calculation as above and check it against the checksum to ensure that no tampering has happened to the kernel.</p>
<p>These values will be used in the next section:</p>
<pre class="assembly"><code>.section .multiboot
.align 4
.long MAGIC
.long FLAGS
.long CHECKSUM</code></pre>
<p>Firstly, a section is made called <code>.multiboot</code> because the header needs to fit in the first 8 KiB of the kernel; putting it in a section gives control over where the section is. Then the header is aligned on 32 bits (for Multiboot header), i.e. the memory address of the next piece of data is a multiple of 4. That data being 4 bytes holding MAGIC. THe other calculated values, FLAGS and CHECKSUM, are also stored.</p>
<h3 id="setting-up-the-stack">Setting up the Stack</h3>
<pre class="assembly"><code>.section .bss
.align 16
stack_bottom:
.skip 16384 /* 16 KiB */
stack_top:</code></pre>
<p><code>.section .bss</code> marks this section as Block Started by Symbol, which typically used for variables that are uninitialized/initialized to 0 or static storage. 16 KiB of bytes are skipped at which point the top of the stack is marked (the stack grows down on x86 machines). It is also of note the on x86 machines, the stack data must be aligned to 16 bytes, hence the align directive.</p>
<h3 id="entry-point">Entry Point</h3>
<pre class="assembly"><code>.section .text
.global _start
.type _start, @function
_start:
    mov $stack_top, %esp
    call kernel_main

    /* enter infinite, halting loop if nothing else to do */
    cli
done: hlt
    jmp done

.size _start, . - _start</code></pre>
<p>Within the text section, define _start, the entry point, as a global so that it can be found more easily and accessed external of this assembly code. Additionally, declare it as a function to help the assembler know what is trying to be done with the _start symbol. <code>cli</code> clears the interrupt flag, disabling interrupts (not that they have even been enabled in this simple kernel) so that, in the loop the kernel will just sit at <code>hlt</code> waiting for an interrupt. If an unavoidable interrupt goes through, though, <code>jump done</code> will put the kernel back in the loop. Additionally, the size of the symbol is set for debugging purposes and is generally helpful. It is calculated as the difference between the current address <code>.</code> and <code>_start</code>.</p>
<p>The code can be assembled with <code>&lt;cross assembler&gt; -o &lt;name&gt;.o &lt;name&gt;.s</code>. Remember that the cross assembler is <code>&lt;prefix&gt;/bin/&lt;target&gt;-as</code>.</p>
<p>This marks the end of the booting code. Next, the kernel functionality.</p>
<h2 id="functionality">Functionality</h2>
<p>This part will be done in C as there is no need for the extensive machine management Assembly offers. Also of note are some terms to be aware of.</p>
<ul>
<li>Hosted Environment: A compilation environment in which there is a standard C library and other useful features offered by the OS. This is the typical environment with which most programmers are familiar.</li>
<li>Freestanding Environment: A compilation environment in which there is <em>no</em> standard C library and <em>no</em> other useful features offered by the OS… because there isn’t one! Yes, for the unfamiliar, this means the standard C library has really always been coming from the OS on which a C program was written. Delving into the low-level world only gets stranger. Note that freestanding headers only provide macros and data types.</li>
</ul>
<p>First in the code (kernel.c, for example), some helpful headers:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;stddef.h&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span></code></pre></div>
<p>These can be used in a freestanding (no development OS’s libraries) environment because they are defined by the compiler, not the standard C library. There are other headers with this same property that will not be listed here, but can be easily googled.</p>
<p>Adding these lines ensures compilation <em>for the target</em> goes smoothly:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="co">/* If the compiler is targeting the wrong operating system. */</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a><span class="pp">#if defined(__linux__)</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a><span class="pp">#error &quot;Use a cross compiler, you will most certainly run into trouble without one!&quot;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a><span class="pp">#endif</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a> </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a><span class="co">/* If the compiler is not built for the target */</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a><span class="pp">#if !defined(__i386__)</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a><span class="pp">#error &quot;This code needs to be compiled with a ix86-elf compiler!&quot;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a><span class="pp">#endif</span></span></code></pre></div>
<h3 id="colors">Colors!</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="kw">enum</span> vga_color {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>    VGA_COLOR_BLACK = <span class="dv">0</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>    VGA_COLOR_BLUE = <span class="dv">1</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a>    VGA_COLOR_GREEN = <span class="dv">2</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>    VGA_COLOR_CYAN = <span class="dv">3</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>    VGA_COLOR_RED = <span class="dv">4</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>    VGA_COLOR_MAGENTA = <span class="dv">5</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>    VGA_COLOR_BROWN = <span class="dv">6</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a>    VGA_COLOR_LIGHT_GREY = <span class="dv">7</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a>    VGA_COLOR_DARK_GREY = <span class="dv">8</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a>    VGA_COLOR_LIGHT_BLUE = <span class="dv">9</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a>    VGA_COLOR_LIGHT_GREEN = <span class="dv">10</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>    VGA_COLOR_LIGHT_CYAN = <span class="dv">11</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a>    VGA_COLOR_LIGHT_RED = <span class="dv">12</span>,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a>    VGA_COLOR_LIGHT_MAGENTA = <span class="dv">13</span>,</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a>    VGA_COLOR_LIGHT_BROWN = <span class="dv">14</span>,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a>    VGA_COLOR_WHITE = <span class="dv">15</span>,</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a>};</span></code></pre></div>
<p>This enumeration sets up color constants recognized by the VGA controller. However, a function should be written to utilize these colors.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">uint8_t</span> vga_entry_color(<span class="kw">enum</span> vga_color fg, <span class="kw">enum</span> vga_color bg) </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>{</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a>    <span class="cf">return</span> bg &lt;&lt; <span class="dv">4</span> | fg;</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a>}</span></code></pre></div>
<p>vga_entry_color() computes the color with which to write a given character to the screen. The background takes up the most significant 4 bits, and the foreground, the least significant 4, for a total of one 1 byte. This value it produces will be used to compute the full information for a character to be written. That function is as follows:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">uint16_t</span> vga_entry(<span class="dt">unsigned</span> <span class="dt">char</span> uc, <span class="dt">uint8_t</span> color) </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>{</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>    <span class="cf">return</span> (<span class="dt">uint16_t</span>) color &lt;&lt; <span class="dv">8</span> | (<span class="dt">uint16_t</span>) uc;</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a>}</span></code></pre></div>
<p>vga_entry() computes a character entry for the VGA controller. These are 2 bytes, where the color is the most significant and the character information is the least.</p>
<h3 id="utility-functions">Utility Functions</h3>
<p>Highlights will be made where needed. Most of this code is straight forward.</p>
<h4 id="string-length">String Length</h4>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="dt">size_t</span> strlen(<span class="dt">const</span> <span class="dt">char</span>* str) </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>{</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>    <span class="dt">size_t</span> len = <span class="dv">0</span>;</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>    <span class="cf">while</span> (str[len])</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>        len++;</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>    <span class="cf">return</span> len;</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>}</span></code></pre></div>
<p><code>size_t</code> is the return type because it can hold dynamically large sizes, which is useful because the string input could be very short or very long. <code>str[len]</code> returns false at the null character.</p>
<h4 id="globals-and-terminal-initialization">Globals and Terminal Initialization</h4>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">size_t</span> VGA_WIDTH = <span class="dv">80</span>;</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">size_t</span> VGA_HEIGHT = <span class="dv">25</span>;</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a> </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a><span class="dt">size_t</span> terminal_row;</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a><span class="dt">size_t</span> terminal_column;</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a><span class="dt">uint8_t</span> terminal_color;</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a><span class="dt">uint16_t</span>* terminal_buffer;</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a> </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a><span class="dt">void</span> terminal_initialize(<span class="dt">void</span>) </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>{</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>    terminal_row = <span class="dv">0</span>;</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a>    terminal_column = <span class="dv">0</span>;</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a>    terminal_color = vga_entry_color(VGA_COLOR_LIGHT_GREY, VGA_COLOR_BLACK);</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a>    terminal_buffer = (<span class="dt">uint16_t</span>*) <span class="bn">0xB8000</span>;</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true"></a>    <span class="cf">for</span> (<span class="dt">size_t</span> y = <span class="dv">0</span>; y &lt; VGA_HEIGHT; y++) {</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true"></a>        <span class="cf">for</span> (<span class="dt">size_t</span> x = <span class="dv">0</span>; x &lt; VGA_WIDTH; x++) {</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true"></a>            <span class="dt">const</span> <span class="dt">size_t</span> index = y * VGA_WIDTH + x;</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true"></a>            terminal_buffer[index] = vga_entry(<span class="ch">&#39; &#39;</span>, terminal_color);</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true"></a>        }</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true"></a>    }</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true"></a>}</span></code></pre></div>
<p>Global variables make for a sad computer scientist. But this example is meant to be simple. <code>0xB800</code> is used as the terminal buffer as it is the specific, memory mapped address to the VGA controller.</p>
<h4 id="terminal-interactions">Terminal Interactions</h4>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="dt">void</span> terminal_setcolor(<span class="dt">uint8_t</span> color) </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>{</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>    terminal_color = color;</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a>}</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a><span class="dt">void</span> terminal_putentryat(<span class="dt">char</span> c, <span class="dt">uint8_t</span> color, <span class="dt">size_t</span> x, <span class="dt">size_t</span> y) </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a>{</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true"></a>    <span class="dt">const</span> <span class="dt">size_t</span> index = y * VGA_WIDTH + x;</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true"></a>    terminal_buffer[index] = vga_entry(c, color);</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true"></a>}</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true"></a> </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true"></a><span class="dt">void</span> terminal_putchar(<span class="dt">char</span> c) </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true"></a>{</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true"></a>    terminal_putentryat(c, terminal_color, terminal_column, terminal_row);</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true"></a>    <span class="cf">if</span> (++terminal_column == VGA_WIDTH) {</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true"></a>        terminal_column = <span class="dv">0</span>;</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true"></a>        <span class="cf">if</span> (++terminal_row == VGA_HEIGHT)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true"></a>            terminal_row = <span class="dv">0</span>;</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true"></a>    }</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true"></a>}</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true"></a> </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true"></a><span class="dt">void</span> terminal_write(<span class="dt">const</span> <span class="dt">char</span>* data, <span class="dt">size_t</span> size) </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true"></a>{</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true"></a>    <span class="cf">for</span> (<span class="dt">size_t</span> i = <span class="dv">0</span>; i &lt; size; i++)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true"></a>        terminal_putchar(data[i]);</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true"></a>}</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true"></a> </span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true"></a><span class="dt">void</span> terminal_writestring(<span class="dt">const</span> <span class="dt">char</span>* data) </span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true"></a>{</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true"></a>    terminal_write(data, strlen(data));</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true"></a>}</span></code></pre></div>
<h3 id="kernel_main">kernel_main()</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="dt">void</span> kernel_main(<span class="dt">void</span>) </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a>{</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a>    terminal_initialize();</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a>    terminal_writestring(<span class="st">&quot;Hello, kernel World!</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a>}</span></code></pre></div>
<p>The function originally set up to be called in the booting Assembly code. All that work for this?</p>
<p>Yeah.</p>
<p>Notes on the function: <code>void</code> in the parameter section just <em>cleanly</em> means the function takes no parameters. The code can be compiled with <code>&lt;cross compiler&gt; -c &lt;name&gt;.c -o &lt;name&gt;.o -ffreestanding -O2</code>. Remember the cross compiler is <code>&lt;prefix&gt;/bin/&lt;target&gt;-gcc</code>. Here is a list of all the flags used and an explanation for their use:</p>
<ul>
<li><code>-c</code> causes the output to be an object file, not fully compiled binary code. Remember this code still needs to be linked with the assembly header written earlier.</li>
<li><code>-ffreestanding</code> instructs the compiler to compile for a freestanding environment.</li>
<li><code>-O2</code> instructs the compiler to optimize at level 2, i.e. makes the code more efficient.</li>
<li><code>-Wall</code> enables all warning messages which, as one my imagine, is very good for kernel development.</li>
<li><code>Wextra</code> enables even more warning messages.</li>
</ul>
<h2 id="linking">Linking</h2>
<p>To link the two object files, a custom linking script must be written to be given to the cross compiler. Typically, that is, in a hosted environment, linking scripts are provided, but in a freestanding environment, such utilities do not exist.</p>
<p>The linking script (linker.ld, for example) is as follows:</p>
<pre><code>ENTRY(_start)

SECTIONS
{
    . = 2M;

    .text BLOCK(4K) : ALIGN(4K)
    {
        *(.multiboot)
        *(.text)
    }

    .rodata BLOCK(4K) : ALIGN(4K)
    {
        *(.rodata)
    }

    .data BLOCK(4K) : ALIGN(4K)
    {
        *(.data)
    }

    .bss BLOCK(4K) : ALIGN(4K)
    {
        *(COMMON)
        *(.bss)
    }
}</code></pre>
<p><code>ENTRY</code>, perhaps unsurprisingly, marks the entry point for the kernel. It being accessible here is why <code>_start</code> was made global in the booting code. The different sections are then ordered in <code>SECTIONS</code>. <code>. = 2M;</code> instructs that the kernel be loaded 2 MiB in memory, leaving room for BIOS/UEFI.</p>
<p>The chunk begun by <code>.text BLOCK(4K) : ALIGN(4k)</code> instructs that the text section (the program instructions) will start at the current location (2M), be placed in blocks of size 4 KiB, and aligned upon a 4 KiB boundary. The multiboot section is put first because, as explained before, it needs to be within the first 8 KiB of the kernel, and this linking script is how that is enforced. The proceeding chunks are similar; <code>.rodata</code> for read only data, <code>.data</code> for the data section, and <code>.bss</code> for the stack. <code>*(COMMON)</code> in the <code>.bss</code> chunk refers to all uninitialized variables (a.k.a. <strong>common</strong> symbols).</p>
<p>The kernel can finally be linked with <code>&lt;cross compiler&gt; -T &lt;linker&gt; -o &lt;kernel name&gt;.bin -ffreestanding -O2 -nostdlib &lt;boot code name&gt;.o &lt;functionality code name&gt;.o -lgcc</code>.</p>
<ul>
<li><code>-T</code> specifies the linking script to be used.</li>
<li><code>-nostdlib</code> shockingly specifies to not expect nor rely on a standard library.</li>
<li><code>-lgcc</code> helps the compiler when using flags such as <code>-nostdlib</code>.</li>
</ul>
<h2 id="verification">Verification</h2>
<p><strong>If GRUB is installed</strong>, the following command can be run to verify that the produced binary is Multiboot-able: <code>grub-file --is-x86-multiboot &lt;kernel name&gt;.bin</code> This command is <em>very</em> nice for kernel development. An exit 0 is successful, and exit 1 unsuccessful. Type <code>echo $?</code> immediately after running the command to see the output. Or write a nice script, if using a shell.</p>
<h1 id="booting-the-kernel">Booting the Kernel</h1>
<p align="center">
<img src="https://placehold.co/400x100?text=WIP" alt="placeholder">
</p>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
